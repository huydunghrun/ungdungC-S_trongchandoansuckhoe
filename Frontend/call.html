<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Video Call Tư Vấn - MindCare</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" rel="stylesheet"/>
  <link href="/css/modern.css" rel="stylesheet"/>
  <style>
    :root {
      --primary: #10b981;
      --danger: #ef4444;
      --muted: #6b7280;
      --bg: #f8fafc;
    }
    body {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      min-height: 100vh;
      font-family: 'Inter', 'Segoe UI', sans-serif;
    }
    .call-container {
      max-width: 1400px;
      margin: 2rem auto;
      background: white;
      border-radius: 28px;
      overflow: hidden;
      box-shadow: 0 25px 70px rgba(16,185,129,0.25);
      height: calc(100vh - 100px);
      display: flex;
      flex-direction: column;
    }
    .call-header {
      background: linear-gradient(135deg, var(--primary), #34d399);
      color: white;
      padding: 1.8rem 2rem;
      text-align: center;
      box-shadow: 0 10px 30px rgba(16,185,129,0.3);
    }
    .doctor-info {
      background: rgba(255,255,255,0.95);
      border-radius: 20px;
      padding: 1.5rem;
      margin: -4rem 2rem 2rem;
      box-shadow: 0 15px 40px rgba(0,0,0,0.1);
      position: relative;
      z-index: 10;
      text-align: center;
    }
    .doctor-avatar {
      width: 100px; height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 6px solid white;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .video-grid {
      flex: 1;
      position: relative;
      background: #1e293b;
      border-radius: 20px;
      margin: 0 2rem 2rem;
      overflow: hidden;
    }
    #remoteVideo {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #localVideo {
      position: absolute;
      bottom: 2rem;
      right: 2rem;
      width: 250px !important;
      height: 180px !important;
      border: 5px solid white;
      border-radius: 18px;
      z-index: 20;
      box-shadow: 0 15px 40px rgba(0,0,0,0.5);
      object-fit: cover;
    }
    .controls {
      position: absolute;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(12px);
      padding: 1rem 2.5rem;
      border-radius: 50px;
      display: flex;
      gap: 1.5rem;
      align-items: center;
      z-index: 30;
      box-shadow: 0 15px 40px rgba(0,0,0,0.4);
    }
    .control-btn {
      width: 60px; height: 60px;
      border-radius: 50%;
      border: none;
      color: white;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: 0 8px 25px rgba(0,0,0,0.4);
    }
    .control-btn:hover { transform: translateY(-6px) scale(1.1); }
    .btn-mic { background: #6b7280; }
    .btn-mic.muted { background: var(--danger); }
    .btn-cam { background: #6b7280; }
    .btn-cam.off { background: var(--danger); }
    .btn-end {
      background: var(--danger);
      width: 70px; height: 70px;
      font-size: 1.8rem;
    }
    .btn-end:hover {
      background: #dc2626;
      transform: rotate(135deg) scale(1.1);
    }
    .timer, .status-indicator {
      position: absolute;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 0.6rem 1.2rem;
      border-radius: 50px;
      font-weight: bold;
      backdrop-filter: blur(10px);
      z-index: 30;
    }
    .timer { top: 2rem; right: 2rem; }
    .status-indicator { top: 2rem; left: 2rem; font-size: 0.9rem; }
    @media (max-width: 992px) {
      #localVideo { width: 150px !important; height: 110px !important; bottom: 8rem; right: 1rem; }
      .controls { flex-wrap: wrap; gap: 1rem; padding: 1rem; }
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div w3-include-html="/components/sidebar.html"></div>

  <!-- Main Content -->
  <div class="main-content p-3 p-md-5">
    <div class="call-container">

      <!-- Header -->
      <div class="call-header">
        <h2 class="fw-bold mb-2">Buổi tư vấn tâm lý trực tuyến</h2>
        <p class="mb-0 opacity-90">Phiên riêng tư • Được mã hóa đầu cuối • An toàn tuyệt đối</p>
      </div>

      <!-- Thông tin bác sĩ -->
      <div class="doctor-info">
        <img src="/img/user-avatar.png" alt="Bác sĩ" class="doctor-avatar" id="doctorAvatar"/>
        <h4 class="mt-3 mb-1 fw-bold text-success" id="doctorName">Đang kết nối...</h4>
        <p class="text-muted mb-0" id="doctorSpecialty">Chuyên gia tâm lý</p>
      </div>

      <!-- Video Area -->
      <div class="video-grid">
        <video id="remoteVideo" autoplay playsinline></video>
        <video id="localVideo" autoplay muted playsinline></video>

        <div class="status-indicator" id="statusText">
          Đang kết nối với bác sĩ...
        </div>

        <div class="timer" id="callTimer">00:00</div>

        <div class="controls">
          <button id="micBtn" class="control-btn btn-mic" title="Tắt/Bật mic">
            <i class="fas fa-microphone"></i>
          </button>
          <button id="camBtn" class="control-btn btn-cam" title="Tắt/Bật camera">
            <i class="fas fa-video"></i>
          </button>
          <button id="endCallBtn" class="control-btn btn-end" title="Kết thúc">
            <i class="fas fa-phone-slash"></i>
          </button>
        </div>
      </div>

    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/peerjs@0.6.1/dist/peerjs.min.js"></script>
  <script src="http://localhost:5001/socket.io/socket.io.js"></script>
  <script src="/js/include.js"></script>
  <script src="/js/auth.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      if (typeof initPage === 'function') await initPage();

      const token = localStorage.getItem('token');
      if (!token) {
        alert('Vui lòng đăng nhập lại');
        window.location.href = 'login.html';
        return;
      }

      const appointmentId = new URLSearchParams(window.location.search).get('appointmentId');
      if (!appointmentId) {
        alert('Không tìm thấy buổi tư vấn');
        window.location.href = 'dashboard-patient.html';
        return;
      }

      // Kết nối Socket.IO với backend cổng 5001
      const socket = io('http://localhost:5001', {
        auth: { token }
      });

      let peer = null;
      let myStream = null;
      let currentCall = null;

      // Lấy thông tin buổi hẹn từ backend
      const loadAppointment = async () => {
        try {
          const res = await fetch(`http://localhost:5001/api/appointments/${appointmentId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await res.json();
          if (res.ok) {
            document.getElementById('doctorName').textContent = data.doctor.name;
            document.getElementById('doctorSpecialty').textContent = data.doctor.specialty || 'Chuyên gia tâm lý';
            document.getElementById('doctorAvatar').src = data.doctor.avatar || '/img/user-avatar.png';
          }
        } catch (err) { console.error('Lỗi tải buổi hẹn:', err); }
      };

      // Bắt đầu video call
      const startCall = async () => {
        try {
          myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
          document.getElementById('localVideo').srcObject = myStream;

          peer = new Peer(undefined, { host: 'localhost', port: 5001, path: '/peerjs' });

          peer.on('open', id => {
            socket.emit('join-call', { appointmentId, peerId: id });
          });

          socket.on('user-joined', ({ peerId }) => {
            document.getElementById('statusText').innerHTML = 'Đã kết nối với bác sĩ';
            document.getElementById('statusText').style.background = 'rgba(34,197,94,0.9)';

            const call = peer.call(peerId, myStream);
            currentCall = call;

            call.on('stream', remoteStream => {
              document.getElementById('remoteVideo').srcObject = remoteStream;
            });
          });

          peer.on('call', call => {
            call.answer(myStream);
            currentCall = call;
            call.on('stream', remoteStream => {
              document.getElementById('remoteVideo').srcObject = remoteStream;
            });
          });

        } catch (err) {
          alert('Không thể truy cập camera/mic. Vui lòng cấp quyền!');
          console.error(err);
        }
      };

      // Bộ đếm giờ
      let seconds = 0;
      setInterval(() => {
        seconds++;
        const mins = String(Math.floor(seconds / 60)).padStart(2, '0');
        const secs = String(seconds % 60).padStart(2, '0');
        document.getElementById('callTimer').textContent = `${mins}:${secs}`;
      }, 1000);

      // Điều khiển mic & cam
      document.getElementById('micBtn').onclick = () => {
        const enabled = myStream.getAudioTracks()[0].enabled;
        myStream.getAudioTracks()[0].enabled = !enabled;
        document.getElementById('micBtn').classList.toggle('muted', !enabled);
      };

      document.getElementById('camBtn').onclick = () => {
        const enabled = myStream.getVideoTracks()[0].enabled;
        myStream.getVideoTracks()[0].enabled = !enabled;
        document.getElementById('camBtn').classList.toggle('off', !enabled);
      };

      // Kết thúc cuộc gọi
      document.getElementById('endCallBtn').onclick = () => {
        if (confirm('Bạn có chắc muốn kết thúc buổi tư vấn?')) {
          if (currentCall) currentCall.close();
          if (peer) peer.destroy();
          socket.disconnect();
          window.location.href = 'dashboard-patient.html';
        }
      };

      // Khởi chạy
      await loadAppointment();
      await startCall();
    });
  </script>
</body>
</html>